# アクティブコンテキスト: Blokus Duo

## 現在の作業焦点

現在のBlokus Duoプロジェクトの作業焦点は以下の通りです：

1. **Python 3.12 + OpenAI Gym環境の設計と実装**
   - Blokus Duo（2人用）ゲームロジックの実装
   - 14x14ボードの実装
   - OpenAI Gym互換インターフェースの設計
   - 2人プレイ用の観測空間と行動空間の定義
   - 報酬関数の設計

2. **強化学習連携の準備**
   - StableBaselines3との連携テスト
   - 対戦型学習パイプラインの設計
   - 自己対戦学習の検討
   - エージェント評価方法の検討
   - ハイパーパラメータ最適化戦略

3. **テスト環境の整備**
   - ゲームロジックのユニットテスト
   - 環境インターフェースのテスト
   - 報酬関数の検証テスト
   - パフォーマンステスト
   - devcontainer環境でのテスト自動化

## 最近の変更

以下の変更が最近実施されました：

1. **プロジェクト方針**
   - Blokus Duo（2人用）ルールの採用
   - Python 3.12での実装に決定
   - OpenAI Gym互換環境としての設計方針を確立
   - StableBaselines3を強化学習フレームワークとして採用
   - UIを持たない環境としての実装方針を決定

2. **技術スタック**
   - Python 3.12の採用
   - devcontainer内でuvを使用した環境管理の決定
   - ruffによるコード品質管理の採用
   - pyrightによる型ヒントの活用
   - テスト駆動開発（TDD）アプローチの確立
   - 必要に応じた可視化ツールの検討開始

3. **設計**
   - プロジェクト構造の初期設計
   - 14x14ボードを使用したBlokus Duo環境の設計
   - OpenAI Gym互換インターフェースの設計開始
   - Python 3.12の型定義の検討
   - devcontainer設定の検討

4. **実装**
   - Board クラスの初期実装とテスト作成
   - Piece クラスの実装と21種類の標準ピース定義
   - 型アノテーションの改善（numpy.ndarrayの型引数を追加）
   - .gitignoreの更新（blokus_duo/env/ディレクトリを含めるように）
   - Blokusゲームルールの実装
     - コーナー接続ルール（corner-to-corner connection）
     - エッジ接続禁止ルール（no edge-to-edge connection）
     - ゲーム終了判定
     - スコア計算

## 次のステップ

以下のタスクが次のステップとして計画されています：

1. **ゲームロジックの実装** ✅
   - 14x14ボード状態の表現 ✅
   - ピース（ポリオミノ）の定義と操作 ✅
   - Blokus Duoの配置ルールの実装 ✅
   - 2人プレイのゲーム状態管理と終了条件 ✅

2. **OpenAI Gym環境の実装** ✅
   - 環境クラスの実装 ✅
   - 2人プレイ用の観測空間と行動空間の定義 ✅
   - ステップ関数の実装 ✅
   - 対戦型学習に適した報酬関数の設計と実装 ✅

3. **強化学習エージェント開発** ✅
   - StableBaselines3との連携 ✅
   - 対戦型学習用エージェントの実装 ✅
   - 自己対戦学習の実装 ✅
   - 学習パラメータの調整 ✅
   - エージェント評価方法の実装 ✅

4. **開発環境の整備**
   - devcontainer設定の実装
   - uvによる依存関係管理の設定
   - ruffの設定とワークフロー統合
   - CI/CDパイプラインの構築

5. **可視化ツール（オプション）**
   - Blokus Duoのゲーム状態の可視化
   - 学習曲線の可視化
   - 対戦結果の分析ツール
   - エージェント行動の分析ツール

## 開発環境の制約

**重要**: このプロジェクトは必ずdevcontainer内で開発を行う必要があります。これは以下の理由から絶対に守るべき制約です：

1. **環境の一貫性**: Python 3.12とすべての依存関係が正しくインストールされた環境を保証
2. **再現性の確保**: すべての開発者が同一の環境で作業できることを保証
3. **ツールチェーンの統合**: uv、ruff、pyrightなどのツールが正しく設定された環境を提供
4. **テスト環境の標準化**: テストが常に同じ環境で実行されることを保証

devcontainerを使用せずに直接ホスト環境で開発やテストを行うことは避けてください。環境の不一致によるバグや問題の原因となります。

### テスト実行環境

テストを実行するには、Makefileを使用して環境に応じた適切な方法でコマンドを実行できます：

```bash
# すべてのテストを実行
make test

# 特定のテストを実行
make test ARGS="tests/unit/test_board.py"

# カバレッジレポート付きでテストを実行
make test-cov

# 特定のテストでカバレッジレポートを生成
make test-cov ARGS="tests/unit/test_board.py"

# リンティング
make lint

# 型チェック
make typecheck

# すべての検証（テスト、リント、型チェック）を実行
make validate
```

Makefileは自動的に実行環境を検出し、devcontainer内で実行されている場合は直接コマンドを実行し、devcontainer外で実行されている場合はDocker Compose経由でコマンドを実行します。これにより、開発者は環境を意識せずに同じコマンドでテストを実行でき、一貫した結果を得ることができます。

## アクティブな決定と考慮事項

現在、以下の決定と考慮事項が進行中です：

### 決定済み事項

1. Blokus Duo（2人用）ルールの採用
2. 14x14ボードサイズの採用
3. Python 3.12での実装
4. **devcontainer内でuvを使用した環境管理（絶対的要件）**
5. ruffによるコード品質管理
6. OpenAI Gym互換環境としての設計
7. StableBaselines3の採用
8. テスト駆動開発による品質確保
9. pyrightによる型ヒントの活用

### 検討中の事項

1. 14x14ボード状態の効率的な表現方法
2. 2人プレイ用の行動空間の設計（離散 vs 連続）
3. 対戦型学習に適した報酬関数の設計
4. 自己対戦学習の実装方法
5. devcontainerの最適な設定
6. ruffの設定とルールセット
7. 可視化ツールの必要性と実装方法
8. 学習効率の最適化戦略

### 課題と懸念

1. Blokus Duoルールの正確な実装
2. 2人対戦環境での学習安定性
3. 自己対戦学習の収束性
4. 行動空間の効率的な扱い
5. 強化学習エージェントの学習効率
6. シミュレーション速度の最適化
7. Python 3.12の新機能と型ヒントの適切な活用方法
8. **devcontainer環境の再現性確保（最優先事項）**

## コミュニケーション方針

プロジェクトメンバー間のコミュニケーションは以下の原則に基づいて行います：

1. Blokus Duoルールの解釈に関する明確な合意
2. 環境設計とエージェント開発の連携
3. テスト失敗時の迅速な対応と協力
4. コードレビューの徹底
5. Python 3.12の型ヒントの一貫した使用
6. ruffによるコード品質の一貫性確保
7. devcontainer環境の共有と再現性確認

このアクティブコンテキストは、Blokus Duoプロジェクトの現在の状態と方向性を示すものであり、作業の進行に伴って定期的に更新されます。テスト駆動開発の実践については、共有メモリバンクの`systemPatterns.md`を参照してください。
